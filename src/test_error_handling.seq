# Test error handling
#
# Tests for arity validation, type errors, undefined symbols,
# division by zero, and error propagation.

include "eval"

# Helper to test error cases - prints the error message
: test-error ( String -- )
  # Stack: Input
  dup parse env-empty eval-with-env
  dup eval-err? if
    swap "PASS " swap string.concat ": " string.concat
    swap eval-err-message string.concat io.write-line
  else
    drop "FAIL: expected error for " swap string.concat io.write-line
  then ;

# Helper to test successful evaluation
: test-ok ( String String -- )
  # Stack: Input Expected
  swap dup  # -> Expected Input Input
  parse env-empty eval-with-env  # -> Expected Input EvalResult
  dup eval-ok? if
    eval-ok-value sexpr-to-string  # -> Expected Input Actual
    2 pick string.equal? if
      drop "PASS: " swap string.concat io.write-line
    else
      # -> Expected Input Actual
      "FAIL: " 2 pick string.concat  # FAIL: Input
      " expected " string.concat
      rot string.concat  # FAIL: Input expected Expected
      " but got " string.concat
      swap string.concat io.write-line  # FAIL: Input expected Expected but got Actual
    then
  else
    # -> Expected Input EvalResult
    eval-err-message  # -> Expected Input ErrMsg
    "FAIL: " 2 pick string.concat  # FAIL: Input
    " unexpected error: " string.concat
    swap string.concat io.write-line
    drop drop  # Clean up Expected
  then ;

: main ( -- )
  "=== Error Handling Tests ===" io.write-line
  "" io.write-line

  "--- Arity Validation ---" io.write-line
  # List operations
  "(car)" test-error
  "(car 'a 'b)" test-error
  "(cdr)" test-error
  "(cons 1)" test-error
  "(cons 1 2 3)" test-error
  # Special forms
  "(if 1 2)" test-error
  "(let x 10)" test-error
  "(lambda (x))" test-error
  "(lambda)" test-error
  "(define x)" test-error
  "(define)" test-error
  "(quote)" test-error
  "(quote 1 2)" test-error
  # Predicates
  "(null?)" test-error
  "(number? 1 2)" test-error
  "(symbol?)" test-error
  "(list? 1 2 3)" test-error
  "(boolean?)" test-error
  # Comparisons
  "(< 1)" test-error
  "(> 1 2 3)" test-error
  "(<= 5)" test-error
  "(>= 1 2 3)" test-error
  "(= 1)" test-error
  "" io.write-line

  "--- Type Validation ---" io.write-line
  # List operations require lists
  "(car 42)" test-error
  "(cdr 'symbol)" test-error
  "(cons 1 2)" test-error
  # car/cdr of empty list
  "(car '())" test-error
  "(cdr '())" test-error
  # Arithmetic operations require numbers
  "(+ 'a 1)" test-error
  "(- 'b 2)" test-error
  "(* 3 'c)" test-error
  "(/ 4 'd)" test-error
  # Comparison operations require numbers
  "(< 'x 1)" test-error
  "(> 2 'y)" test-error
  "(<= 'a 'b)" test-error
  "(>= 1 '())" test-error
  "(= 'foo 'bar)" test-error
  "" io.write-line

  "--- Undefined Symbols ---" io.write-line
  "undefined-var" test-error
  "(undefined-func 1 2)" test-error
  "(+ 1 unknown)" test-error
  "" io.write-line

  "--- Division by Zero ---" io.write-line
  "(/ 1 0)" test-error
  "(/ 10 2 0)" test-error
  "(/ 100 (- 5 5))" test-error
  "" io.write-line

  "--- Error Propagation ---" io.write-line
  "(+ 1 (car))" test-error
  "(* (/ 1 0) 5)" test-error
  "(if (car) 1 2)" test-error
  "(let x (/ 1 0) x)" test-error
  "(list 1 (car) 3)" test-error
  "(begin 1 (/ 1 0) 3)" test-error
  "" io.write-line

  "--- Recovery After Errors ---" io.write-line
  "(+ 1 2)" "3" test-ok
  "(car '(a b c))" "a" test-ok
  "(/ 10 2)" "5" test-ok
  "(if #t 'yes 'no)" "yes" test-ok
  "(let x 5 (+ x 3))" "8" test-ok
  "" io.write-line

  "--- List Operations (append, reverse) ---" io.write-line
  # append tests
  "(append '(1 2) '(3 4))" "(1 2 3 4)" test-ok
  "(append '() '(1 2))" "(1 2)" test-ok
  "(append '(1 2) '())" "(1 2)" test-ok
  "(append '() '())" "()" test-ok
  "(append)" test-error
  "(append '(1))" test-error
  "(append 1 '(2))" test-error
  "(append '(1) 2)" test-error
  # reverse tests
  "(reverse '(1 2 3))" "(3 2 1)" test-ok
  "(reverse '(a))" "(a)" test-ok
  "(reverse '())" "()" test-ok
  "(reverse)" test-error
  "(reverse 42)" test-error
  "(reverse '(1) '(2))" test-error
  "" io.write-line

  "--- Higher-Order Functions (map, filter, fold) ---" io.write-line
  # map tests
  "(map (lambda (x) (+ x 1)) '(1 2 3))" "(2 3 4)" test-ok
  "(map (lambda (x) (* x x)) '(1 2 3 4))" "(1 4 9 16)" test-ok
  "(map (lambda (x) x) '(a b c))" "(a b c)" test-ok
  "(map (lambda (x) x) '())" "()" test-ok
  "(map)" test-error
  "(map (lambda (x) x))" test-error
  "(map 42 '(1 2 3))" test-error
  "(map (lambda (x) x) 42)" test-error
  # filter tests
  "(filter (lambda (x) (> x 2)) '(1 2 3 4 5))" "(3 4 5)" test-ok
  "(filter (lambda (x) #t) '(1 2 3))" "(1 2 3)" test-ok
  "(filter (lambda (x) #f) '(1 2 3))" "()" test-ok
  "(filter (lambda (x) x) '())" "()" test-ok
  # filter with various truthy returns (symbols, numbers, lists are truthy; only #f and () are falsy)
  "(filter (lambda (x) 'yes) '(1 2 3))" "(1 2 3)" test-ok
  "(filter (lambda (x) (if (> x 2) x #f)) '(1 2 3 4 5))" "(3 4 5)" test-ok
  "(filter (lambda (x) (if (> x 2) '() #t)) '(1 2 3 4 5))" "(1 2)" test-ok
  "(filter)" test-error
  "(filter (lambda (x) x))" test-error
  "(filter 42 '(1 2 3))" test-error
  "(filter (lambda (x) x) 42)" test-error
  # fold tests
  "(fold (lambda (acc x) (+ acc x)) 0 '(1 2 3 4 5))" "15" test-ok
  "(fold (lambda (acc x) (* acc x)) 1 '(1 2 3 4 5))" "120" test-ok
  "(fold (lambda (acc x) acc) 0 '(1 2 3))" "0" test-ok
  "(fold (lambda (acc x) x) 0 '(1 2 3))" "3" test-ok
  "(fold (lambda (acc x) (+ acc 1)) 0 '(a b c d e))" "5" test-ok
  "(fold (lambda (acc x) acc) 42 '())" "42" test-ok
  "(fold)" test-error
  "(fold (lambda (acc x) acc))" test-error
  "(fold (lambda (acc x) acc) 0)" test-error
  "(fold 42 0 '(1 2 3))" test-error
  "(fold (lambda (acc x) acc) 0 42)" test-error
  "" io.write-line

  "=== All Tests Complete ===" io.write-line
;
